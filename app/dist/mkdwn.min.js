/*! mkdwn - v2.0.0 - 2012-12-21
 * Copyright (c) 2012 Alejandro Morales; Licensed MIT
 */
window.App={},define("app/helpers",function(){"use strict";function t(e,n,r){Object.keys(n).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}),n.__proto__&&r&&t(e,n.__proto__)}function n(e,t){var n={};return n[e]=t,n}function i(e){var t="";while(e--)t+=String.fromCharCode(Math.floor(Math.random()*255));return t}function s(t){if(!(this instanceof s))return new s(t);var n={},o=this,u=new Set;this.id=i(5),this.type=t,r.get(t,function(e){if(!e[t])return o.set(t,"");Object.keys(e[t]).forEach(function(n){o.set(n,e[t][n])})}),o.lastChange=+(new Date),this.on("change",function(e){o.lastChange=+(new Date);switch(e.action){case"delete":u.delete(e.item);break;case"new":case"modify":u.add(e.item.name);break;case"clear":r.remove(t),u=new Set;break;default:}}),e.defineProperty(this,{store:[function(){return n},function(){return n}],rset:[function(){return u},function(){console.log("set",arguments)}]}),window.onclose=function(){o.save()},this.schedule()}var e,r=chrome.storage.sync;return s.prototype=new ui.Emitter,t(s.prototype,{get keys(){return Object.keys(this.store)},get length(){return this.keys.length},get items(){return this.store},save:function(){r.remove(this.type),r.set(n(this.type,this.store))},schedule:function(){var e=this;e.writeInterval=setInterval(function(){if(+(new Date)-e.lastChange>4e3)return;console.log("saving",e.type),e.save()},4e3)},key:function(e){return this.keys[e]},set:function(e,t){var n=this;if(typeof e=="object")return Object.keys(e).forEach(function(t){n.set(t,e[t])});this.store[e]=t,this.emit("change",{action:"new",item:{name:e,value:t}})},remove:function(e){delete this.store[e],this.emit("change",{action:"delete",item:e})},get:function(e){return this.store[e]},clear:function(){return this.emit("change",{action:"clear"}),r.clear()},has:function(e){return this.rset.has(e)},raw:r}),e={Storage:window.isNode?window.Store:s,decorate:t,store:r,id:function(t){var n="aeiouAEIOU",r="bcdfghjklmnpqrstvwxyBCDFzLMNSXPRTW",i="",s=t||6,o=0,u;for(;o<s;o+=1)u=o%2===0?n:r,i+=u[Math.floor(Math.random()*u.length)];return i},nextTick:function(e,t){return t&&(e=e.bind(t)),setTimeout(e,0)},defineProperty:function(t,n,r,i){if(typeof n=="object"){var s=Object.keys(n);return s.forEach(function(r){return e.defineProperty(t,r,n[r][0],n[r][1])})}try{Object.defineProperty(t,n,{get:r,set:i||function(){},enumerable:!1})}catch(o){console.log("[ERROR]",o.stack)}}},e}),define("app/fs",function(){"use strict";function e(){console.error("[ERROR]",arguments)}function t(t,n){if(!t)return console.log("[error] no fileEntry");t.createWriter(function(e){e.onwriteend=function(){e.onwriteend=null,e.truncate(n.length)},e.onerror=function(e){console.log("Write failed: "+e.toString())};var t=new Blob([n],{type:"text/plain"});e.write(t)},e)}function n(n,r){window.webkitRequestFileSystem(1,1048576,function(i){i.root.getFile(r,{create:!0},function(e){t(e,n)},e)},e)}function r(e){chrome.fileSystem.chooseEntry({type:"saveFile"},function(n){t(n,e||App.e.textContent)})}return{save:r,saveFile:n}}),define("app/reader",function(){"use strict";var e=require("app/helpers");return App.Reader=function(t){if(!(this instanceof App.Reader))return new App.Reader(t);App.e.on("change",this.parse.bind(this)),this.el=$('[name="'+(t||"output")+'"]'),this.active=!0},App.Reader.prototype.html=function(){var e=App.editor.textContent;try{e=marked(e)}catch(t){console.log("[ERROR] EPARSINGER")}return e},App.Reader.prototype.parse=function(){if(!App.UI.read)return;e.nextTick(function(){this.el.html(this.html()),this.last=+(new Date),this.el.find("code").each(function(e,t){var n=$(t),r=n.html(),i;r=r.replace(/‘/g,"'").replace(/’/g,"'").replace(/“/g,'"').replace(/”/g,'"'),n.html(r),i=t.className.split(/\s+/),i.forEach(function(e){if(e.indexOf("lang-")!==-1){var t=e.substring("lang-".length);n.attr("data-language",t)}});try{Rainbow.color()}catch(s){}})},this)},App.Reader}),define("app/ui",function(){"use strict";var e=require("app/helpers"),t=require("app/fs"),n=$(".write"),r=$(".read"),i=$("#title"),s=!0,o=!0,u=!1;return App.UI=Object.create({menu:ui.menu(),createDialog:function(e,t){return ui.dialog(e,t).closable().overlay().show()},rename:function(){var e=$(this.load("rename")),t=this.createDialog("New Name:",e);t.on("close",function(){App.e.rename(e.val())})},render:function(e,t){return e.replace(/<%=([\s\S]+?)%>/g,function(e,n){return n=n.trim(),t[n]?t[n]:void 0})},load:function(e){return $('[name="tmpl-'+e+'"]').text()},showAll:function(){var e=this.load("list"),t=App.e.items.length,n=[],r,i=0;for(;i<=t;++i){var s=App.e.items.key(i)||"";if(!s)continue;n.push(this.render(e,{id:s}))}e=$("<ul>"+n.join("")+"</ul>"+'<button data-action="close" class="button">Cancel</button>'),r=this.createDialog("Files:",e),e.on("click",function(){r.hide()})},btns:function(e){var t=this;e.forEach(function(e){$("#"+e).on("click",function(e){var n=$(e.target),r=n.data().binding||"";t.actions[r]&&t.actions[r].apply(this,arguments)})})},actions:{"new":function(){},rfsc:function(){n.toggle(),s&&!u?(r.removeClass("half").addClass("full"),u=!0,s=!1):(r.removeClass("full").addClass("half"),u=!1,o=!0,s=!0),App.e.emit("change")},wfsc:function(){r.toggle(),o&&!u?(n.removeClass("half").addClass("full"),u=!0,o=!1):(n.removeClass("full").addClass("half"),u=!1,o=!0,s=!0),App.e.emit("change")},menu:function(t){t.preventDefault(),e.nextTick(function(){App.UI.menu.moveTo(t.pageX,t.pageY).show()})},options:function(){chrome.app.window.create("app/options.html")},saveHTML:function(){return t.save(App.reader.html())}},toggleTitle:function(){i.slideToggle(),setTimeout(function(){i.slideToggle()},2e3)},read:o,write:s}),App.UI}),define("app/editor",function(){function s(){}var e=require("app/helpers"),t=e.decorate,n=e.Storage,r=new n("items"),i=new n("cfg");return App.Editor=function(){if(!(this instanceof App.Editor))return new App.Editor;var t=ace.edit("editor");ui.Emitter.call(this),ace.config.set("workerPath","components/ace/build/src"),t.getSession().setMode("ace/mode/markdown"),t.renderer.setShowGutter(!1),t.setKeyboardHandler(this.get("cfg:keyboard")),this.initialize(t)},App.Editor.prototype=new ui.Emitter,t(App.Editor.prototype,{initialize:function(t){var n=this.emit.bind(this,"change");e.store.get("last",function(r){var i=r.last;i||(i=window.location.hash||e.id()),this.id=i.replace("#",""),e.store.set({last:this.id}),window.location.hash=this.id,this.el=t,this.title=$('[data-id="name"]').text(this.id),this.setupStorage(),this.el.on("keypress",n),this.el.on("change",n),this.on("change",this.save.bind(this)),e.defineProperty(this,"textContent",function(){return this.el.getValue()},function(e){return this.el.getSession().setValue(e)}),this.emit("ready")}.bind(this))},cleanCanvas:function(){this.textContent=""},save:function(){e.nextTick(function(){r.set(this.id,{id:this.id,textContent:this.textContent,mtime:+(new Date)})},this)},get:function(e){return e?~e.indexOf(":")?(e=e.split(":"),this[e[0]][e[1]]||""):this[e]:r.get(this.id)},cfg:function(){if(!i)return{};var e={vim:require("ace/keyboard/vim").handler,emacs:require("ace/keyboard/emacs").handler,"default":require("ace/keyboard/vim").handler};return i.get("keyboard")||i.set("keyboard","default"),i.set("keyboard",e[i.get("keyboard")||"default"]),i.items}(),setupStorage:function(){var t=this.get();t?this.merge(t):(window.location.hash=this.id,this.save(s)),e.nextTick(this.emit.bind(this,"change"))},merge:function(e){t(this,e)},rename:function(e){var t=r.get(e);t||(this.remove(),this.id=e,this.save()),window.location.hash=this.id},remove:function(){r.remove(this.id),this.initialize(this.el)},set:function(e,t,n){n?this[e]=t:(r.set(e,t),this.emit("item:saved"))},changeTo:function(t){if(r.has(t)){this.save();var n=r.get(t);n&&(this.id=t,this.mtime=n.mtime,this.textContent=n.textContent||"",$('[data-id="name"]').text(this.id),e.store.set({last:this.id}),this.emit("change"))}},items:r}),App.Editor});var oldRequire=require;setTimeout(function(){"use strict";var e=require("app/editor"),t=require("app/reader");require("app/ui"),window.isNode&&(window.require=oldRequire),$(document).ready(function(){var n=$("#title");App.initialize=function(){marked.setOptions({gfm:!0,sanitize:!0}),["showAll","rename"].forEach(function(e){App.UI[e]=App.UI[e].bind(App.UI)}),App.editor=App.e=new e,App.reader=App.r=new t,App.UI.menu.add("New &lt;alt+n&gt;",App.e.newCanvas).add("Load &lt;alt+o&gt;",App.UI.showAll).add("Set Name",App.UI.rename).add("Rename",App.UI.rename).add("Clean all",App.e.cleanCanvas),App.UI.btns(["wbtns","rbtns"]),App.UI.actions.wfsc(),window.oncontextmenu=function(e){e.preventDefault(),App.UI.menu.moveTo(e.pageX,e.pageY).show()},window.onhashchange=function(){var e=window.location.hash.replace("#","");App.e.changeTo(e)}},App.initialize(),setTimeout(function(){n.slideToggle()},5e3);var r=+(new Date);$("#wrapper").hover(function(e){e.pageY<5&&+(new Date)-r>2e3&&(App.UI.toggleTitle(),r=+(new Date))})})},200);